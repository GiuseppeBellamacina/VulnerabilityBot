import streamlit as st
import httpx
import asyncio
import pandas as pd

from utilities import load_config

async def send_queries(queries: list, url: str) -> httpx.Response:
    try:
        async with httpx.AsyncClient(verify=False) as client:
            response = await client.post(url + '/db/insert', json=queries)
            response.raise_for_status()
            return response
    except httpx.RequestError as e:
        return e
    except httpx.HTTPStatusError as e:
        return e

def run_asyncio_task(task):
    return asyncio.run(task)

def excel_parser(records: list) -> list:
    queries = []
    for record in records:
        query = {
            "cwe": record.get("cwe"),
            "code": record.get("line"),
            "vulnerability": record.get("message").partition("Remediations")[0].replace("#", "").strip(),
            "technologies": record.get("language")
        }
        queries.append(query)
    return queries

config = load_config("config.yaml")

st.set_page_config(page_title="Vulnerability Bot", page_icon="ðŸ”’")
st.title("Vulnerability Bot")
st.subheader("Send Queries")

db_url = config['urls']['db']
url = st.text_input("DB URL", db_url, key="url_input", help="Enter the URL of the DB")

st.write("Enter Query Details:")
vulnerability = st.text_input("Vulnerability")
technologies = st.text_input("Technologies")
cwe = st.text_input("CWE")
code = st.text_input("Code")

if 'queries' not in st.session_state:
    st.session_state['queries'] = []
if 'has_uploaded_file' not in st.session_state:
    st.session_state['has_uploaded_file'] = False

uploaded_file = st.file_uploader("Upload Excel File", type="xlsx")
if not uploaded_file:
    st.session_state['has_uploaded_file'] = False
if uploaded_file and st.session_state['queries'] == [] and not st.session_state['has_uploaded_file']:
    try:
        records = pd.read_excel(uploaded_file).to_dict(orient='records')
        file_content = excel_parser(records)
        st.session_state['queries'].extend(file_content)
        st.session_state['has_uploaded_file'] = True
        st.success("File uploaded successfully!")
    except Exception as e:
        st.error(f"Error: {e}")

if st.button("Add Query"):
    if not (cwe and code and vulnerability and technologies):
        st.warning("Please fill out all fields before adding a query.")
    else:
        query = {
            "cwe": cwe,
            "code": code,
            "vulnerability": vulnerability,
            "technologies": technologies
        }
        st.session_state['queries'].append(query)
        st.success("Query added!")

st.write("Current Queries:")
queries = st.session_state['queries']

for idx, query in enumerate(queries):
    with st.expander(f"Query {idx + 1}"):
        col1, col2 = st.columns(2)
        with col1:
            st.write("### Edit Query")
            edited_vulnerability = st.text_input("Edit Vulnerability", value=query['vulnerability'], key=f"edit_vulnerability_{idx}")
            edited_technologies = st.text_input("Edit Technologies", value=query['technologies'], key=f"edit_technologies_{idx}")
            edited_cwe = st.text_input("Edit CWE", value=query['cwe'], key=f"edit_cwe_{idx}")                        
            edited_code = st.text_input("Edit code", value=query['code'], key=f"edit_code_{idx}")
            if st.button("Update Query", key=f"update_query_{idx}"):
                query['vulnerability'] = edited_vulnerability
                query['technologies'] = edited_technologies
                query['cwe'] = edited_cwe
                query['code'] = edited_code
        
        with col2:
            st.write("### Delete Query")
            if st.button("Delete Query", key=f"delete_query_{idx}"):
                st.session_state['queries'].pop(idx)
                st.rerun()
                
if st.button("Send Queries"):
    if not queries:
        st.warning("Please add queries before sending.")
        st.stop()
    try:
        response = run_asyncio_task(send_queries(queries, url))
        if isinstance(response, httpx.Response) and response.status_code == 200:
            st.success("Queries sent successfully!")
            st.session_state['queries'] = []
        else:
            st.error("Failed to send queries.")
            st.write(response)
    except Exception as e:
        st.error(f"Error: {e}")
